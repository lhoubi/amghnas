<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- UPDATED: More descriptive and keyword-rich Title Tag -->
    <title>Online Tifinagh Keyboard | Type Tamazight & Amazigh Script with Latin/Arabic Input | amghnas.com</title>

    <!-- NEW: Meta Description for SEO -->
    <meta name="description" content="Use our free online Tifinagh keyboard to type Tamazight/Amazigh script. Easily convert Latin or Arabic input to Tifinagh characters. Perfect for learning and writing." />
    
    <!-- NEW: Meta Keywords (less critical now, but still good practice for some engines) -->
    <meta name="keywords" content="Tifinagh keyboard, online Tifinagh, Tamazight keyboard, Amazigh keyboard, Berber keyboard, type Tifinagh, Latin to Tifinagh, Arabic to Tifinagh, Tifinagh script, virtual keyboard" />

    <!-- Favicon -->
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="shortcut icon" href="favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="favicon.png"> <!-- Recommended for iOS devices -->

    <!-- Google Fonts: Using Roboto for general text and Playfair Display for main titles -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons (used in buttons like backspace, copy, clear) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- Noto Sans Tifinagh font: Crucial for displaying Tifinagh characters correctly -->
    <!-- Noto Naskh Arabic font: For displaying Arabic characters correctly -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Tifinagh&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;700&display=swap');

:root{
  --primary-color:#334155;
  --secondary-color:#64748b;
  --accent-color:#0d9488;
  --accent-rgb:13,148,136;
  --background-color:#f8fafc;
  --background-color-light:#e2e8f0;
  --text-color:#1e293b;
  --text-color-light:#475569;
  --border-color:#cbd5e1;
  --button-bg:#f1f5f9;
  --button-text-color:#334155;
  --delete-button-bg:#ef4444;
  --delete-button-text-color:#ffffff;
  --border-radius:10px;
}

/* dark theme variables kept for parity */
html.dark{
  --primary-color:#94a3b8;
  --secondary-color:#64748b;
  --accent-color:#2dd4bf;
  --accent-rgb:45,212,191;
  --background-color:#1e293b;
  --background-color-light:#334155;
  --text-color:#f8fafc;
  --text-color-light:#cbd5e1;
  --border-color:#475569;
  --button-bg:#3b4a5e;
  --button-text-color:#f1f5f9;
  --delete-button-bg:#dc2626;
  --delete-button-text-color:#ffffff;
}

*{box-sizing:border-box}
body{
  font-family:'Roboto',sans-serif;
  background-color:var(--background-color);
  color:var(--text-color);
  margin:0;
  padding:20px;
  display:flex;
  justify-content:center;
}

.container{
  max-width:1000px;
  width:100%;
  background-color:var(--background-color-light);
  border-radius:var(--border-radius);
  box-shadow:0 4px 20px rgba(0,0,0,0.08);
  padding:30px;
}

/* header / controls */
.header-controls{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
}
.nav-button, #themeToggle{
  padding:10px 15px;
  border-radius:8px;
  border:2px solid var(--border-color);
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  text-decoration:none;
  transition:all .25s ease;
  box-shadow:0 2px 4px rgba(0,0,0,.08);
}
.nav-button{ background-color:var(--secondary-color); color:#fff; border-color:var(--secondary-color); }
#themeToggle{ background-color:var(--button-bg); color:var(--button-text-color); }

h1{
  font-family:'Playfair Display',serif;
  font-size:2.5em;
  text-align:center;
  color:var(--primary-color);
  margin:25px 0 10px;
}
.tagline{
  text-align:center;
  font-size:1.1em;
  color:var(--text-color-light);
  margin-bottom:30px;
}

/* input */
.input-area-wrapper{ display:flex; justify-content:center; }
.text-input{
  width:100%;
  max-width:800px;
  height:150px;
  padding:15px;
  font-size:1.4em;
  border:2px solid var(--border-color);
  border-radius:var(--border-radius);
  background-color:var(--background-color);
  color:var(--text-color);
  font-family:'Noto Sans Tifinagh','Noto Naskh Arabic','Roboto',sans-serif;
  line-height:1.6;
  resize:vertical;
}

/* Action buttons */
.action-buttons{
  display:flex;
  justify-content:center;
  gap:15px;
  margin:25px 0;
  flex-wrap:wrap;
}
.action-buttons button{
  padding:12px 22px;
  border-radius:var(--border-radius);
  border:2px solid var(--border-color);
  font-size:1.05em;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  transition:all .25s ease;
  box-shadow:0 3px 6px rgba(0,0,0,.12);
}
.copy{ background-color:var(--accent-color); color:#fff; border-color:var(--accent-color); }
.clear{ background-color:var(--secondary-color); color:#fff; border-color:var(--secondary-color); }

/* ---------------------
   KEYBOARD LAYOUT + LABEL FIX
   --------------------- */

/* main layout */
.keyboard-layout{
  display:flex;
  flex-direction:column;
  gap:12px;
  padding:10px;
}

/* keyboard rows center and keep consistent spacing */
.keyboard-row{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:12px;
}

/* IMPORTANT: change how key-group is structured:
   - Use column layout so labels sit above the key
   - Keep a fixed visual box width so labels align correctly
*/
.key-group{
  display:flex;
  flex-direction:column;       /* stack: latin label -> arabic label -> button */
  align-items:center;
  gap:6px;
  width:76px;                  /* fixed visual column width to match screenshot spacing */
  min-width:76px;
  max-width:76px;
  padding-top:6px;             /* create slight vertical offset like in screenshot */
  box-sizing:border-box;
  text-align:center;
}

/* Latin label (small, centered) */
.latin-label{
  display:block;
  font-size:0.72rem;
  color:var(--text-color-light);
  line-height:1;
  letter-spacing:0.6px;
  text-transform:lowercase;
  white-space:nowrap;
  pointer-events:none;
  width:100%;
  text-align:center;
}

/* Arabic label (small, centered under latin label)
   Use Arabic font and rtl direction but centered visually */
.arabic-label{
  display:block;
  font-size:0.65rem;
  color:var(--text-color-light);
  line-height:1;
  font-family:'Noto Naskh Arabic',sans-serif;
  direction:rtl;
  white-space:nowrap;
  pointer-events:none;
  width:100%;
  text-align:center;
  margin-top:-2px; /* slight overlap to match screenshot spacing */
}

/* the visible key button */
.keyboard-key{
  height:56px;
  width:100%;
  border-radius:12px;
  border:2px solid var(--border-color);
  background-color:var(--button-bg);
  color:var(--button-text-color);
  font-size:1.6rem;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:all .15s ease;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  user-select:none;
}

/* hover / active affordances */
.keyboard-key:hover{ transform:translateY(-3px); border-color:var(--accent-color); background-color:rgba(var(--accent-rgb),0.08); }
.keyboard-key:active{ transform:translateY(0); box-shadow:0 1px 3px rgba(0,0,0,.06); }

/* delete key styling */
.keyboard-key.delete{
  background-color:var(--delete-button-bg);
  color:var(--delete-button-text-color);
  border-color:var(--delete-button-bg);
  box-shadow:0 3px 8px rgba(239,68,68,0.18);
}

/* adjust wide / space keys */
.keyboard-key.wide{ height:56px; font-size:1.15rem; }

/* footer */
.footer{
  text-align:center;
  margin-top:50px;
  padding-top:20px;
  border-top:1px solid var(--border-color);
  color:var(--text-color-light);
  font-size:0.9em;
}

/* ---------------------
   Responsiveness — keep exact desktop look but tidy mobile
   --------------------- */
@media (max-width: 1024px){
  .key-group{ width:72px; min-width:72px; max-width:72px; }
  .keyboard-key{ height:54px; font-size:1.4rem; }
}

@media (max-width: 768px){
  .container{ padding:20px; }
  h1{ font-size:2em; }
  .tagline{ font-size:1em; margin-bottom:20px; }
  .text-input{ height:130px; font-size:1.2em; }
  .key-group{ width:66px; min-width:66px; max-width:66px; gap:4px; }
  .latin-label{ font-size:0.68rem; }
  .arabic-label{ font-size:0.62rem; margin-top:-1px; }
  .keyboard-key{ height:48px; font-size:1.2rem; border-radius:10px; }
}

@media (max-width: 480px){
  body{ padding:10px; }
  .container{ padding:15px; }
  h1{ font-size:1.7em; }
  .tagline{ font-size:0.95em; }
  .text-input{ height:120px; font-size:1.1em; }
  .key-group{ width:60px; min-width:60px; max-width:60px; }
  .latin-label{ font-size:0.64rem; }
  .arabic-label{ font-size:0.58rem; }
  .keyboard-key{ height:42px; font-size:1.05rem; border-radius:10px; }
}

/* Red Fire Glow Effect for active keys */
.keyboard-key.key-active {
  animation: fireGlow 0.15s forwards; /* Short animation for a quick glow */
}

@keyframes fireGlow {
  0% {
    box-shadow: 0 0 0px 0px rgba(255, 69, 0, 0.7); /* Start with no glow */
    border-color: var(--accent-color); /* Keep original border color */
    transform: translateY(0); /* Ensure it doesn't move on activation */
  }
  50% {
    box-shadow: 0 0 12px 6px rgba(255, 69, 0, 0.7), /* Red glow */
                0 0 20px 10px rgba(255, 140, 0, 0.5); /* Orange secondary glow */
    border-color: #ff4500; /* Red border */
    background-color: #ff6347; /* Lighter red background */
    color: #fff; /* White text for contrast */
  }
  100% {
    box-shadow: 0 0 0px 0px rgba(255, 69, 0, 0.7); /* Fade out glow */
    border-color: var(--border-color); /* Return to normal border */
    background-color: var(--button-bg); /* Return to normal background */
    color: var(--button-text-color); /* Return to normal text color */
  }
}

/* Optional: Adjust hover for delete button when active */
.keyboard-key.delete.key-active {
  animation: fireGlowDelete 0.15s forwards;
}

@keyframes fireGlowDelete {
  0% {
    box-shadow: 0 0 0px 0px rgba(255, 69, 0, 0.7);
    border-color: var(--delete-button-bg);
    transform: translateY(0);
  }
  50% {
    box-shadow: 0 0 12px 6px rgba(255, 69, 0, 0.7),
                0 0 20px 10px rgba(255, 140, 0, 0.5);
    border-color: #ff4500;
    background-color: #ff6347;
    color: #fff;
  }
  100% {
    box-shadow: 0 3px 8px rgba(239,68,68,0.18); /* Revert to normal delete shadow */
    border-color: var(--delete-button-bg);
    background-color: var(--delete-button-bg);
    color: var(--delete-button-text-color);
  }
}

/* Visually hidden utility class */
.visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    padding: 0;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

/* Ensure the sun icon is hidden by default if moon is shown by default */
.sun-icon.hidden { display: none; }
.moon-icon.hidden { display: none; }

</style>


</head>
<body>

    <div class="container">
        <!-- Header Controls for Navigation & Dark Mode Toggle -->
        <div class="header-controls">
            <!-- Navigation link back to the main converter page - improved anchor text -->
            <a href="index.html" class="nav-button">
                <i class="fas fa-arrow-left"></i> Tifinagh Converter
            </a>
            <!-- Dark Mode Toggle Button -->
            <button id="themeToggle" aria-label="Toggle light and dark mode">
                <i class="fas fa-moon moon-icon"></i> <!-- Moon icon for light mode, shown by default -->
                <i class="fas fa-sun sun-icon hidden"></i> <!-- Sun icon for dark mode, hidden by default -->
                Toggle Dark Mode
            </button>
        </div>

        <!-- Main Title for the Keyboard Page - improved with more keywords and `sr-only` -->
        <h1>Online Tifinagh Keyboard <span class="visually-hidden">for Tamazight and Amazigh Script</span></h1>
        <p class="tagline">Type directly in Tifinagh using this virtual keyboard, or your physical keyboard with Latin/Arabic input. This tool helps you write Tamazight and Amazigh characters easily.</p>

        <!-- The input area should be centered within its available width -->
        <div class="input-area-wrapper">
            <!-- Improved placeholder text with keywords -->
            <textarea id="keyboardInput" class="text-input" placeholder="Start typing in Tifinagh, Latin, or Arabic here to generate Tifinagh text..." lang="ber" inputmode="text"></textarea>
        </div>

        <!-- Action Buttons: Copy and Clear (MOVED HERE to be between input and keyboard) -->
        <div class="action-buttons">
            <button class="copy" id="copyBtn"><i class="fas fa-copy"></i> Copy Tifinagh Text</button>
            <button class="clear" id="clearBtn"><i class="fas fa-eraser"></i> Clear Text</button>
        </div>

        <!-- Virtual Keyboard Section -->
        <section class="keyboard-section">
            <div class="keyboard-layout">

                <!-- Keyboard Row 1 -->
                <div class="keyboard-row">
                    <div class="key-group" data-latin="a" data-arabic="ا"> <span class="latin-label">a</span><span class="arabic-label">ا- الفتحة</span> <button class="keyboard-key" data-key="ⴰ">ⴰ</button> </div>
                    <div class="key-group" data-latin="b" data-arabic="ب"> <span class="latin-label">b</span><span class="arabic-label">ب</span> <button class="keyboard-key" data-key="ⴱ">ⴱ</button> </div>
                    <div class="key-group" data-latin="d" data-arabic="د"> <span class="latin-label">d</span><span class="arabic-label">د</span> <button class="keyboard-key" data-key="ⴷ">ⴷ</button> </div>
                    <div class="key-group" data-latin="ḍ" data-arabic="ض"> <span class="latin-label">ḍ</span><span class="arabic-label">ض</span> <button class="keyboard-key" data-key="ⴹ">ⴹ</button> </div>
                    <div class="key-group" data-latin="e" data-arabic=""> <span class="latin-label">e</span><span class="arabic-label"></span> <button class="keyboard-key" data-key="ⴻ">ⴻ</button> </div>
                    <div class="key-group" data-latin="f" data-arabic="ف"> <span class="latin-label">f</span><span class="arabic-label">ف</span> <button class="keyboard-key" data-key="ⴼ">ⴼ</button> </div>
                    <div class="key-group" data-latin="g" data-arabic="ڭ"> <span class="latin-label">g</span><span class="arabic-label">ڭ</span> <button class="keyboard-key" data-key="ⴳ">ⴳ</button> </div>
                    <div class="key-group" data-latin="h" data-arabic="ه"> <span class="latin-label">h</span><span class="arabic-label">ه</span> <button class="keyboard-key" data-key="ⵀ">ⵀ</button> </div>
                    <div class="key-group" data-latin="ḥ" data-arabic="ح"> <span class="latin-label">ḥ</span><span class="arabic-label">ح</span> <button class="keyboard-key" data-key="ⵃ">ⵃ</button> </div>
                    <div class="key-group" data-latin="i" data-arabic="إ"> <span class="latin-label">i</span><span class="arabic-label">إ-الكسرة</span> <button class="keyboard-key" data-key="ⵉ">ⵉ</button> </div>
                    <div class="key-group" data-latin="j" data-arabic="ج"> <span class="latin-label">j</span><span class="arabic-label">ج</span> <button class="keyboard-key" data-key="ⵊ">ⵊ</button> </div>
                    <div class="key-group" data-latin="k" data-arabic="ك"> <span class="latin-label">k</span><span class="arabic-label">ك</span> <button class="keyboard-key" data-key="ⴽ">ⴽ</button> </div>
                    <div class="key-group" data-latin="l" data-arabic="ل"> <span class="latin-label">L</span><span class="arabic-label">ل</span> <button class="keyboard-key" data-key="ⵍ">ⵍ</button> </div>
                </div>

                <!-- Keyboard Row 2 -->
                <div class="keyboard-row">
                    <div class="key-group" data-latin="m" data-arabic="م"> <span class="latin-label">m</span><span class="arabic-label">م</span> <button class="keyboard-key" data-key="ⵎ">ⵎ</button> </div>
                    <div class="key-group" data-latin="n" data-arabic="ن"> <span class="latin-label">n</span><span class="arabic-label">ن</span> <button class="keyboard-key" data-key="ⵏ">ⵏ</button> </div>
                    <div class="key-group" data-latin="p" data-arabic="پ"> <span class="latin-label">p</span><span class="arabic-label">پ</span> <button class="keyboard-key" data-key="ⵒ">ⵒ</button> </div>
                    <div class="key-group" data-latin="q" data-arabic="ق"> <span class="latin-label">q</span><span class="arabic-label">ق</span> <button class="keyboard-key" data-key="ⵇ">ⵇ</button> </div>
                    <div class="key-group" data-latin="r" data-arabic="ر"> <span class="latin-label">r</span><span class="arabic-label">ر</span> <button class="keyboard-key" data-key="ⵔ">ⵔ</button> </div>
                    <div class="key-group" data-latin="ṛ" data-arabic=""> <span class="latin-label">Ṛ</span><span class="arabic-label"></span> <button class="keyboard-key" data-key="ⵕ">ⵕ</button> </div>
                    <div class="key-group" data-latin="s" data-arabic="س"> <span class="latin-label">s</span><span class="arabic-label">س</span> <button class="keyboard-key" data-key="ⵙ">ⵙ</button> </div>
                    <div class="key-group" data-latin="sh" data-arabic="ش"> <span class="latin-label">sh</span><span class="arabic-label">ش</span><button class="keyboard-key" data-key="ⵛ">ⵛ</button> </div>
                    <div class="key-group" data-latin="ṣ" data-arabic="ص"> <span class="latin-label">ṣ</span><span class="arabic-label">ص</span> <button class="keyboard-key" data-key="ⵚ">ⵚ</button> </div>
                    <div class="key-group" data-latin="t" data-arabic="ت"> <span class="latin-label">t</span><span class="arabic-label">ت</span> <button class="keyboard-key" data-key="ⵜ">ⵜ</button> </div>
                    <div class="key-group" data-latin="ṭ" data-arabic="ط"> <span class="latin-label">ṭ</span><span class="arabic-label">ط</span> <button class="keyboard-key" data-key="ⵟ">ⵟ</button> </div>
                    <div class="key-group" data-latin="u" data-arabic="أُ"> <span class="latin-label">u</span><span class="arabic-label">أُ-الضمة</span> <button class="keyboard-key" data-key="ⵓ">ⵓ</button> </div>
                    <div class="key-group" data-latin="v" data-arabic="ڤ"> <span class="latin-label">v</span><span class="arabic-label">ڤ</span> <button class="keyboard-key" data-key="ⵠ">ⵠ</button> </div>
                </div>

                <!-- Keyboard Row 3 -->
                <div class="keyboard-row">
                    <div class="key-group" data-latin="w" data-arabic="و"> <span class="latin-label">w</span><span class="arabic-label">و</span> <button class="keyboard-key" data-key="ⵡ">ⵡ</button> </div>
                    <div class="key-group" data-latin="kh" data-arabic="خ"> <span class="latin-label">kh</span><span class="arabic-label">خ</span> <button class="keyboard-key" data-key="ⵅ">ⵅ</button> </div>
                    <div class="key-group" data-latin="y" data-arabic="ي"> <span class="latin-label">y</span><span class="arabic-label">ي</span> <button class="keyboard-key" data-key="ⵢ">ⵢ</button> </div>
                    <div class="key-group" data-latin="z" data-arabic="ز"> <span class="latin-label">z</span><span class="arabic-label">ز</span> <button class="keyboard-key" data-key="ⵣ">ⵣ</button> </div>
                    <div class="key-group" data-latin="ẓ" data-arabic=""> <span class="latin-label">ẓ</span><span class="arabic-label"></span> <button class="keyboard-key" data-key="ⵥ">ⵥ</button> </div>
                    <div class="key-group" data-latin="ʷ" data-arabic="ـ"> <span class="latin-label">ʷ</span><span class="arabic-label">ـ</span> <button class="keyboard-key" data-key="ⵯ">ⵯ</button> </div>
                    <div class="key-group" data-latin="ⵄ" data-arabic="ع"> <span class="latin-label">A</span><span class="arabic-label">ع</span> <button class="keyboard-key" data-key="ⵄ">ⵄ</button> </div>
                    <div class="key-group" data-latin="C" data-arabic="ش"> <span class="latin-label">C</span><span class="arabic-label">ش</span> <button class="keyboard-key" data-key="ⵛ">ⵛ</button> </div>
                    <!-- Additional unique keys could go here, if any more are identified -->
                </div>

                <!-- Final Row: SPACE and DELETE buttons -->
                <div class="keyboard-row final-action-row">
                    <div class="key-group" style="flex-grow: 4; max-width: 400px; min-width: 200px;" data-latin=" " data-arabic=" "> <!-- Increased flex-grow and max-width for spacebar -->
                        <span class="latin-label visually-hidden">Space</span>
                        <span class="arabic-label visually-hidden">مسافة</span>
                        <button class="keyboard-key wide" data-key=" ">SPACE</button>
                    </div>
                
                    <div class="key-group">
                        <span class="latin-label visually-hidden">Del</span>
                        <span class="arabic-label visually-hidden">حذف</span>
                        <button class="keyboard-key delete" data-key="backspace" title="Backspace">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

            </div>
        </section>

        <!-- Footer Section -->
        <footer class="footer">
            <p>&copy; 2026 Tifinagh & Talatint Converter. All rights reserved.</p>
            <p>Made with <i class="fas fa-heart" aria-hidden="true"></i> for Amazigh culture.
                <br> <!-- NEW: Line break for cleaner presentation -->
                By: Anaruz Elhabib <!-- NEW: Requested credit line -->
            </p>
            <!-- NEW: Internal link back to the main -->
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const keyboardInput = document.getElementById('keyboardInput');
        const keyboardKeys = document.querySelectorAll('.keyboard-key');
        const copyBtn = document.getElementById('copyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const themeToggle = document.getElementById('themeToggle');
        const moonIcon = document.querySelector('.moon-icon');
        const sunIcon = document.querySelector('.sun-icon');

        let isDarkMode = false; // Keep track of theme state

        // --- Theme Toggle Functionality ---
        // Load theme preference from localStorage
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            isDarkMode = true;
            moonIcon.classList.add('hidden');
            sunIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
            isDarkMode = false;
            moonIcon.classList.remove('hidden');
            sunIcon.classList.add('hidden');
        }

        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            isDarkMode = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

            moonIcon.classList.toggle('hidden', isDarkMode);
            sunIcon.classList.toggle('hidden', !isDarkMode);
        });

        // --- Virtual Keyboard Input ---
        keyboardKeys.forEach(key => {
            key.addEventListener('click', () => {
                const keyValue = key.dataset.key;
                handleInput(keyValue);
                applyClickEffect(key); // Apply the visual click effect
            });
        });

        function handleInput(keyValue) {
            let start = keyboardInput.selectionStart;
            let end = keyboardInput.selectionEnd;
            let currentValue = keyboardInput.value;

            if (keyValue === 'backspace') {
                if (start > 0) {
                    let newValue = currentValue.substring(0, start - 1) + currentValue.substring(end);
                    keyboardInput.value = newValue;
                    keyboardInput.selectionStart = keyboardInput.selectionEnd = start - 1;
                }
            } else if (keyValue === ' ') { // Handle space explicitly
                let newValue = currentValue.substring(0, start) + ' ' + currentValue.substring(end);
                keyboardInput.value = newValue;
                keyboardInput.selectionStart = keyboardInput.selectionEnd = start + 1;
            } else {
                let newValue = currentValue.substring(0, start) + keyValue + currentValue.substring(end);
                keyboardInput.value = newValue;
                keyboardInput.selectionStart = keyboardInput.selectionEnd = start + keyValue.length;
            }
            keyboardInput.focus(); // Keep focus on the textarea
        }

        // --- Physical Keyboard Mapping ---
        // Map common Latin/Arabic keys to Tifinagh characters
        const keyMap = {
            'a': 'ⴰ', 'b': 'ⴱ', 'd': 'ⴷ', 'D': 'ⴹ', 'e': 'ⴻ', 'f': 'ⴼ', 'g': 'ⴳ', 'h': 'ⵀ', 'H': 'ⵃ',
            'i': 'ⵉ', 'j': 'ⵊ', 'k': 'ⴽ', 'l': 'ⵍ', 'm': 'ⵎ', 'n': 'ⵏ', 'p': 'ⵒ', 'q': 'ⵇ',
            'r': 'ⵔ', 'R': 'ⵕ', 's': 'ⵙ', 'S': 'ⵚ', 't': 'ⵜ', 'T': 'ⵟ', 'u': 'ⵓ', 'v': 'ⵠ',
            'w': 'ⵡ', 'x': 'ⵅ', 'y': 'ⵢ', 'z': 'ⵣ', 'Z': 'ⵥ',
            // Arabic to Tifinagh mappings (can be expanded)
            'ا': 'ⴰ', 'ب': 'ⴱ', 'د': 'ⴷ', 'ض': 'ⴹ', 'ف': 'ⴼ', 'ڭ': 'ⴳ', 'ه': 'ⵀ', 'ح': 'ⵃ',
            'إ': 'ⵉ', 'ج': 'ⵊ', 'ك': 'ⴽ', 'ل': 'ⵍ', 'م': 'ⵎ', 'ن': 'ⵏ', 'پ': 'ⵒ', 'ق': 'ⵇ',
            'ر': 'ⵔ', 'س': 'ⵙ', 'ش': 'ⵛ', 'ص': 'ⵚ', 'ت': 'ⵜ', 'ط': 'ⵟ', 'و': 'ⵡ', 'خ': 'ⵅ',
            'ي': 'ⵢ', 'ز': 'ⵣ',
            // Special cases
            ' ': ' ', // Space bar
            'Backspace': 'backspace',
            // For 'sh' sound, often 'ch' or 'sh' in Latin, map to 'ⵛ'
            // For 'kh' sound, often 'kh' or 'x' in Latin, map to 'ⵅ'
            // Consider multi-key input later if needed, but for now single key is easier.
        };

        // Improved mapping for common Latin ligatures/digraphs often used for Tifinagh sounds
        const latinToTifinaghMap = {
            'a': 'ⴰ', 'b': 'ⴱ', 'd': 'ⴷ', 'e': 'ⴻ', 'f': 'ⴼ', 'g': 'ⴳ', 'h': 'ⵀ', 'i': 'ⵉ',
            'j': 'ⵊ', 'k': 'ⴽ', 'l': 'ⵍ', 'm': 'ⵎ', 'n': 'ⵏ', 'p': 'ⵒ', 'q': 'ⵇ', 'r': 'ⵔ',
            's': 'ⵙ', 't': 'ⵜ', 'u': 'ⵓ', 'v': 'ⵠ', 'w': 'ⵡ', 'y': 'ⵢ', 'z': 'ⵣ',
            // Specific Tifinagh characters with Latin equivalents
            'c': 'ⵛ', // Often used for 'sh'
            'ch': 'ⵛ', // sh
            'x': 'ⵅ', // kh
            'kh': 'ⵅ', // kh
            'gh': 'ⵖ', // gh (if you add it)
            'dj': 'ⵊ', // dj
            'ts': 'ⵜⵙ', // ts (ligature)
            'dz': 'ⴷⵣ', // dz (ligature)
            // Tifinagh characters that might be typed with specific Latin keys (e.g., with diacritics)
            'd.': 'ⴹ', // d with dot (ḍ)
            'h.': 'ⵃ', // h with dot (ḥ)
            'r.': 'ⵕ', // r with dot (ṛ)
            's.': 'ⵚ', // s with dot (ṣ)
            't.': 'ⵟ', // t with dot (ṭ)
            'z.': 'ⵥ', // z with dot (ẓ)
            // For the 'ʷ' character (labialization mark)
            'o': 'ⵓ', // Can be used for U
            '0': 'ⵓ', // Can be used for U
            '6': 'ⵡ', // Or a similar number that makes sense
        };

        document.addEventListener('keydown', (e) => {
            // Only process if the textarea is focused
            if (document.activeElement === keyboardInput) {
                const key = e.key;

                // Handle backspace directly for physical keyboard
                if (key === 'Backspace') {
                    e.preventDefault(); // Prevent default browser back action
                    handleInput('backspace');
                    // Find and apply effect to the delete button
                    const deleteKeyBtn = document.querySelector('.keyboard-key.delete');
                    if (deleteKeyBtn) applyClickEffect(deleteKeyBtn);
                    return;
                }

                // Handle space directly for physical keyboard
                if (key === ' ') {
                    e.preventDefault(); // Prevent default space behavior (e.g., scrolling)
                    handleInput(' ');
                    // Find and apply effect to the space button
                    const spaceKeyBtn = document.querySelector('.keyboard-key.wide[data-key=" "]');
                    if (spaceKeyBtn) applyClickEffect(spaceKeyBtn);
                    return;
                }

                // Try to find a direct mapping
                let tifinaghChar = keyMap[key.toLowerCase()];
                if (tifinaghChar) {
                    e.preventDefault(); // Prevent default Latin character from appearing
                    handleInput(tifinaghChar);
                    // Find the corresponding virtual key and apply effect
                    const virtualKey = document.querySelector(`.keyboard-key[data-key="${tifinaghChar}"]`);
                    if (virtualKey) applyClickEffect(virtualKey);
                    return;
                }
                
                // Handle multi-key input for Latin digraphs (e.g., 'sh' -> 'ⵛ')
                // This is more complex and usually involves buffering input.
                // For now, let's stick to single key mappings and direct Tifinagh entry for physical keyboard.
                // If the user types 'sh' on a physical keyboard, they'd get 's' then 'h'.
                // A full "transliteration engine" would be needed for complex mapping.
                // You could consider mapping 'shift+s' to 'ṣ' etc. for advanced physical keyboard use.
            }
        });


        // --- Action Buttons (Copy/Clear) ---
        copyBtn.addEventListener('click', () => {
            keyboardInput.select();
            // For modern browsers, use navigator.clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(keyboardInput.value)
                    .then(() => {
                        console.log('Tifinagh text copied to clipboard!');
                        // Optional: Show a temporary "Copied!" message
                        const originalText = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalText;
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('Failed to copy text: ', err);
                        fallbackCopyTextToClipboard(keyboardInput.value); // Fallback for older browsers
                    });
            } else {
                fallbackCopyTextToClipboard(keyboardInput.value);
            }
        });

        clearBtn.addEventListener('click', () => {
            keyboardInput.value = '';
            keyboardInput.focus();
        });

        // Fallback for copying text (older browsers)
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; // Avoid scrolling to bottom
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                console.log('Fallback: Tifinagh text copied to clipboard!');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 1500);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        // --- Click Effect Function (Red Fire) ---
        function applyClickEffect(element) {
            element.classList.add('key-active');
            setTimeout(() => {
                element.classList.remove('key-active');
            }, 150); // Duration of the glow effect
        }
    });
</script>
